
CC     = @CC@
CFLAGS = @CFLAGS@ -I. -I@top_srcdir@/lib $(shell pkg-config fuse --cflags) $(shell pkg-config libcurl --cflags)
LIBS   = -lsodium -L@top_srcdir@/lib -lcrypt4gh $(shell pkg-config fuse --libs) $(shell pkg-config libcurl --libs)

prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR = @bindir@

ifdef DEBUG
CFLAGS += -DDEBUG=$(DEBUG) -g
endif

C4GH_HEADERS = passphrase.h key.h base64.h cli.h permissions.h json.h $(wildcard jsmn/*.h)
C4GH_SOURCES = passphrase.c key.c base64.c cli.c permissions.c json.c $(wildcard jsmn/*.c)
C4GH_OBJECTS = $(C4GH_SOURCES:%.c=%.o)

.PHONY: all clean install
.SUFFIXES: .c .o

all: crypt4gh

@top_srcdir@/lib/libcrypt4gh.so:
	make -C @top_srcdir@/lib libcrypt4gh.so

$(BINDIR):
	@echo "Creating bin dir: $(BINDIR)"
	@install -d $(BINDIR)

crypt4gh: @top_srcdir@/lib/libcrypt4gh.so
crypt4gh: $(C4GH_HEADERS)
crypt4gh: main.o $(C4GH_OBJECTS)
	@echo "Linking objects into $@"
	@$(CC) $(CFLAGS) -o $@ $< $(LIBS) $(C4GH_OBJECTS)

crypt4gh-keygen: $(C4GH_HEADERS)
crypt4gh-keygen: keygen.o $(C4GH_OBJECTS)
	@echo "Linking objects into $@"
	@$(CC) $(CFLAGS) -o $@ $< $(LIBS) $(C4GH_OBJECTS)

crypt4gh-fuse: $(C4GH_HEADERS)
crypt4gh-fuse: fuse.o $(C4GH_OBJECTS)
	@echo "Linking objects into $@"
	@$(CC) $(CFLAGS) -o $@ $< $(LIBS) $(C4GH_OBJECTS)

%.o: %.c
ifdef DEBUG
	@echo "Compiling $< (debug: $(DEBUG))"
else
	@echo "Compiling $<"
endif
	@$(CC) $(CFLAGS) -c -o $@ $<

install: crypt4gh | $(BINDIR)
	@echo "Installing $< into $(BINDIR)"
	@install -m 700 $< $(BINDIR)

clean:
	-rm -f crypt4gh $(C4GH_OBJECTS)

