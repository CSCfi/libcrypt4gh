
CC     = @CC@
CFLAGS = @CFLAGS@ -I. -I@top_srcdir@/lib $(shell pkg-config fuse --cflags) $(shell pkg-config libcurl --cflags)
LIBS   = -lsodium -L@top_srcdir@/lib -lcrypt4gh $(shell pkg-config fuse --libs) $(shell pkg-config libcurl --libs)

prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR = @bindir@

ifdef DEBUG
CFLAGS += -DDEBUG=$(DEBUG) -g
endif

C4GH_HEADERS = permissions.h json.h $(wildcard jsmn/*.h)
C4GH_SOURCES = permissions.c json.c $(wildcard jsmn/*.c) fuse.c
C4GH_OBJECTS = $(C4GH_SOURCES:%.c=%.o)

.PHONY: all clean install
.SUFFIXES: .c .o .so

all: crypt4ghfs

@top_srcdir@/lib/libcrypt4gh.so:
	make -C @top_srcdir@/lib libcrypt4gh.so
#	make -C @top_srcdir@/lib install

crypt4ghfs: $(C4GH_HEADERS) $(C4GH_OBJECTS) | @top_srcdir@/lib/libcrypt4gh.so
	@echo "Linking objects into $@"
	@$(CC) $(CFLAGS) -o $@ $< $(LIBS) $(C4GH_OBJECTS)

%.o: %.c
ifdef DEBUG
	@echo "Compiling $< (debug: $(DEBUG))"
else
	@echo "Compiling $<"
endif
	@$(CC) $(CFLAGS) -c -o $@ $<

$(BINDIR):
	@echo "Creating bin dir: $(BINDIR)"
	@install -d $(BINDIR)

install: crypt4ghfs | $(BINDIR)
	@echo "Installing $< into $(BINDIR)"
	@install -m 700 $< $(BINDIR)

clean:
	-rm -f cryptgh-fuse $(C4GH_OBJECTS)

cleandist: clean
	-rm -f Makefile

